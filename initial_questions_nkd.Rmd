---
title: "Initial Question for the Floodplain Forest Data"
author: "Noah Dean"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r, include = F}
# This code chunk just loads in all of the necessary packages as well as the primary dataframe that will be used in the analysis
knitr::opts_chunk$set(warning = F, error = F, message = F, echo = F, include = F)

library(tidyverse)
library(rlist)
library(gridExtra)

df <- read_csv(paste(dirname(rstudioapi::getSourceEditorContext()$path), '/clean_data/UMRS_FPF_clean.csv', sep =''))

df
```

### Question 1: How many unique species are inventoried across the UMRS?

```{r include = F}

# We can just use the unique function to find all of the unique members of the TR_SP column.  This will give us all of the species recorded
species <- unique(df$TR_SP)

species

```


There are `r length(species)` unique species that were observed.  This count includes the `SNAG` and `NONE` species types.  If we don't include these, then we will have `r length(species) - 2` unique species that were observed.

### Question 2: What are the 5 most abundant species by stem count?  How does this vary by health class?

```{r}

# Changes theme to put title in center
theme_update(plot.title = element_text(hjust = 0.5), legend.position = 'none')

# Finds the counts of each species and arranges it in descending order
counts <- df %>% count(TR_SP) %>% 
  arrange(desc(n))

# Creates a bar chart that shows the counts of the 5 most common species
count_plot <- counts[1:5, ] %>%  ggplot(aes(x = reorder(TR_SP,-n), y = n, fill = TR_SP)) + 
  geom_col() + 
  labs(title = 'Top 5 species', x = 'Species', y = 'Count') 

# Initializes lists that will be used to store the species and plots when do this by health class
health_plot_list <- list()
species_list <- list()

health_classes <- c('V', 'S', 'SD')
# Use the above health_class vector to iterate through each of the health classes in this for loop
for (i in 1:3){
  # Finds counts of each species in that health class then arranges it in descending order
  health_counts <- df %>% filter(TR_HLTH == health_classes[i]) %>% 
    count(TR_SP) %>% 
    arrange(desc(n))
  
  # Takes the top 5 species and appends it to the species list
  species_list <- species_list %>% list.append(health_counts$TR_SP[1:5])
  
  # Generates the plot title based on the health class
  plot_title <- paste('Top 5 species in',health_classes[i],'health class', sep = ' ')
  
  # Creates the plot of 5 most abundant species in that health class
  health_count_plot <- health_counts[1:5,] %>% ggplot(aes(x = reorder(TR_SP, -n), y = n, fill = TR_SP)) + 
    geom_col() + 
    labs(title = plot_title, x = 'Species', y = 'Count') + 
    theme(legend.position = "none")
  
  # Appends the plot to this list to easily store it
  health_plot_list <- health_plot_list %>% list.append(health_count_plot)
}

# New variable for the lists to make it easier to type out
hpl <- health_plot_list
sl <- species_list

# Generates a single plot that has all of the above four plots in it.
count_plot_all <- grid.arrange(count_plot, hpl[[1]], hpl[[2]], hpl[[3]])

```

Across all health classes, the five most abundant species were `r counts$TR_SP[1:5]`.  If we were to look at the health classes, the most abundant species are slightly different.  For the `V` (vigorous) class, the five most abundant species are `r sl[[1]]`.  For the `S` (Stressed) class, it's `r sl[[2]]`.  And finally for the `SD` (significant decline) health class, it's `r sl[[3]]`.

```{r, fig_height = 4, fig_width = 6,  fig.fullwidth = TRUE, include = T, fig.align = 'center'}

plot(count_plot_all)

```

### Question 3: What are the 5 most abundant species by basal area.


```{r}
# This code chunk is essentially the same as the above code chunk.  Just instead of ordering the species by count.  It is ordering them based off of basal area

ba_species <- df %>% group_by(TR_SP) %>% 
  summarise(TotBA = sum(BasalArea), .groups = 'keep') %>% 
  arrange(desc(TotBA))

ba_species

overall_ba_plot <- ba_species[1:5, ] %>%  ggplot(aes(x = reorder(TR_SP,-TotBA), y = TotBA, fill = TR_SP)) +
  geom_col() +
  labs(title = 'Top Basal Areas', x = 'Species', y = 'Basal Area')

overall_ba_plot

health_plot_list <- list()
species_list <- list()

health_classes <- c('V', 'S', 'SD')

for (i in 1:3){
  health_counts <- df %>% filter(TR_HLTH == health_classes[i]) %>% 
    group_by(TR_SP) %>% 
    summarise(n = sum(BasalArea), .groups = 'keep') %>% 
    arrange(desc(n))
  
  species_list <- species_list %>% list.append(health_counts$TR_SP[1:5])
  
  plot_title <- paste('Top Basal Areas in',health_classes[i],'health class', sep = ' ')
  
  health_count_plot <- health_counts[1:5,] %>% ggplot(aes(x = reorder(TR_SP, -n), y = n, fill = TR_SP)) + 
    geom_col() + 
    labs(title = plot_title, x = 'Species', y = 'Basal Area') + 
    theme(legend.position = "none")
  
  health_plot_list <- health_plot_list %>% list.append(health_count_plot)
}

bapl <- health_plot_list
sl_ba <- species_list


BA_plot_all <- grid.arrange(overall_ba_plot, bapl[[1]], bapl[[2]], bapl[[3]])


```

Across all health classes, the five most abundant species by basal area were `r ba_species$TR_SP[1:5]`.  If we were to look at the health classes, the most abundant species are slightly different.  For the `V` (vigorous) class, the five most abundant species are `r sl_ba[[1]]`.  For the `S` (Stressed) class, it's `r sl_ba[[2]]`.  And finally for the `SD` (significant decline) health class, it's `r sl_ba[[3]]`.

These are nearly the same as species abundance by stem count, but with a few exceptions.  In the overall counts, ULAM outnumbers QUBI, but QUBI has a higher basal area.  This is again true in the vigorous health class where QUBI and BENI both have larger areas than ULAM.  In the S health class PODE3 moves from rank 5 in stem count to rank 2 in basal area.  In this same health class, ULAM is removed from the top 5 and SALIX moves in.  The SD health class is nearly the same.  The only difference is that PODE3 took rank 4, which removed ACNE2 from the top 5.  


```{r, fig_height = 4, fig_width = 6,  fig.fullwidth = TRUE, include = T, fig.align = 'center'}

plot(BA_plot_all)

```


### Question 4: What are the rarest species?

```{r}

# Rearranges the counts object to be in ascending order then the plot is the same as previously
rare_counts <- counts %>% arrange(n) 

rare_count_plot <- rare_counts[1:5,] %>% ggplot(aes(x = TR_SP, y = n, fill = TR_SP)) + 
  geom_col()

rare_count_plot

# Creates a table with the 5 rarest species and then selects the relavent columns (species, PID, TR_HLTH, BasalArea)
rare_species_tab <- df %>% filter(TR_SP %in% rare_counts$TR_SP[1:5])

rare_species_tab

rare_species_tab_clean <- rare_species_tab %>% select(TR_SP, PID, TR_HLTH, BasalArea) %>% 
  arrange(TR_SP)

colnames(rare_species_tab_clean) <- c('Species', 'Plot ID', 'TR_HLTH', 'Basal Area')
rare_species_tab_clean

```


```{r include = T}
knitr::kable(rare_species_tab_clean)
```

The 5 rarest species found are `r rare_counts$TR_SP[1:5]`.  PRSE3 and QUPA were the only ones that had multiples in the same plot.  The rest were all in unique plots.  


### Question 5: How many pure plots are there?  How many plots have only 2 species?

```{r}

# This first finds how many distinct species each plot has.  Then it groups by the number of distinct species to find how many plots have that number of distinct species.
purity <- df %>% group_by(PID) %>% 
  summarize(unique_sp = length(unique(TR_SP))) %>% 
  group_by(unique_sp) %>% 
  summarize(count = length(PID))

purity

```

There are `r purity$count[1]` plots with 1 species present and `r purity$count[2]` plots with 2 species present.  These make up `r round(100*purity$count[1]/sum(purity$count), digits = 2)`% and `r round(100*purity$count[2]/sum(purity$count), digits = 2)`% of the total plots respectively.


### Question 6: Are there any species unique to a navigation pool or USACE district?

```{r}

# Groups the df by species and finds how many pools that species is located in
pools_with_species <- df %>% group_by(TR_SP) %>% 
  summarize(n_pools = length(unique(POOL)))

# Finds counts of how many species are in x number of pools
counts_of_pools <- pools_with_species %>% group_by(n_pools) %>% 
  summarize(count = length(TR_SP))

counts_of_pools

# next two objects are the same as above but with districts
dist_with_species <- df %>% group_by(TR_SP) %>% 
  summarize(n_dist = length(unique(District)))

counts_of_districts <- dist_with_species %>% group_by(n_dist) %>% 
  summarize(count = length(TR_SP))

counts_of_districts

# This just finds the specific pools that have a species unique to them
pool_uniques <- (pools_with_species %>% filter(n_pools == 1))$TR_SP
pools_with_uniques <- unique((df %>% filter(TR_SP %in% pool_uniques))$POOL)
  
dist_uniques <- (dist_with_species %>% filter(n_dist == 1))$TR_SP
dist_with_uniques <- unique((df %>% filter(TR_SP %in% dist_uniques))$District)


```

`r counts_of_pools$count[1]` pools have a species unique to that pool.  `r counts_of_districts$count[1]` distrcits have a species unique to that district.  The pools with unique species are `r pools_with_uniques`.  The districts with unique species are `r dist_with_uniques`. 


### Question 7: Stats about snags

```{r}

# Finds the proportion of snags in each plot
snag_proportion <- df %>% group_by(PID) %>% 
  summarize(p = sum(TR_SP == 'SNAG')/length(TR_SP))

# Generates a histogram based on proportion of snags across all plots
snag_hist <- snag_proportion %>%  ggplot(aes(x = p)) + 
  geom_histogram() + 
  labs(title = 'Histogram of snag proportion in plots', x = 'Snag proportion', y = 'Count')

snag_hist

# Creates a list of plots that have only snags
all_snag_plots <- (snag_proportion %>% filter(p == 1))$PID

all_snag_plots

# Both of the next two objects get the counts of snags from each species.  It's separated into two separate lists where the total count is greater than 100 or less than 100.  This is purely to make plotting the data easier
snag_count_greater <- df %>% filter(TR_SP == 'SNAG') %>% 
  group_by(TR_SP2) %>% 
  summarize(count = length(TR_SP2)) %>% 
  filter(count >= 100)

snag_count_lesser <- df %>% filter(TR_SP == 'SNAG') %>% 
  group_by(TR_SP2) %>% 
  summarize(count = length(TR_SP2)) %>% 
  filter(count < 100)

# These two objects get the distribution of snag DBH for each species in their respective count classes
snag_DBH_greater <- df %>% filter(TR_SP == 'SNAG', TR_SP2 %in% snag_count_greater$TR_SP2) 

snag_DBH_lesser <- df %>% filter(TR_SP == 'SNAG', TR_SP2 %in% snag_count_lesser$TR_SP2) 

# Generates a histogram based on the DBH of snags for each species
snag_DBH_hist_greater <- snag_DBH_greater %>% ggplot(aes(x = TR_DIA)) +
  geom_histogram() + 
  ggtitle('Histogram of snag DBH when the total count is greater than 100') +
  facet_wrap(~TR_SP2) 
  
  
snag_DBH_hist_lesser <- snag_DBH_lesser %>% ggplot(aes(x = TR_DIA)) +
  geom_histogram() + 
  facet_wrap(~TR_SP2) + 
  ggtitle('Histogram of snag DBH when the total count is less than 100')

snag_DBH_hist_greater
snag_DBH_hist_lesser


```

```{r, fig_height = 4, fig_width = 6,  fig.fullwidth = TRUE, include = T, fig.align = 'center'}

plot(snag_DBH_hist_greater)
plot(snag_DBH_hist_lesser)

```


```{r, fig_height = 4, fig_width = 6,  fig.fullwidth = TRUE, include = T, fig.align = 'center'}

plot(snag_hist)


```


There are some plots that have only snags.  These plots are: `r all_snag_plots`.





